# ======================
#  LEDS â€” CORE ENGINE
# ======================

# ---- Per-group states ----
[gcode_macro LED_STATE_L]
variable_mode: "off"
variable_r: 0.0
variable_g: 0.0
variable_b: 0.0
variable_brightness: 0.30
variable_tick: 0
variable_pulse_val: 0.30
variable_pulse_dir: 1.0
gcode:

[gcode_macro LED_STATE_R]
variable_mode: "off"
variable_r: 0.0
variable_g: 0.0
variable_b: 0.0
variable_brightness: 0.30
variable_tick: 0
variable_pulse_val: 0.30
variable_pulse_dir: 1.0
gcode:

[gcode_macro LED_STATE_CL]
variable_mode: "off"
variable_r: 0.0
variable_g: 0.0
variable_b: 0.0
variable_brightness: 0.30
variable_tick: 0
variable_pulse_val: 0.30
variable_pulse_dir: 1.0
gcode:

[gcode_macro LED_STATE_CR]
variable_mode: "off"
variable_r: 0.0
variable_g: 0.0
variable_b: 0.0
variable_brightness: 0.30
variable_tick: 0
variable_pulse_val: 0.30
variable_pulse_dir: 1.0
gcode:

[gcode_macro LED_STATE_TH]
variable_mode: "off"
variable_r: 0.0
variable_g: 0.0
variable_b: 0.0
variable_brightness: 0.30
variable_tick: 0
variable_pulse_val: 0.30
variable_pulse_dir: 1.0
gcode:

# ---- Boot: seed per-group brightness from user config ----
[delayed_gcode LED_BOOT]
initial_duration: 0.20
gcode:
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=brightness VALUE={printer["gcode_macro LED_GROUPS"].brightness_L|float}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=brightness VALUE={printer["gcode_macro LED_GROUPS"].brightness_R|float}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=brightness VALUE={printer["gcode_macro LED_GROUPS"].brightness_CL|float}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=brightness VALUE={printer["gcode_macro LED_GROUPS"].brightness_CR|float}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=brightness VALUE={printer["gcode_macro LED_GROUPS"].brightness_TH|float}

# ---- Scratch holder for resolved device + index window ----
[gcode_macro _LED_TMP]
variable_led: "main_strip"
variable_from: 1
variable_to: 1
gcode:

# ---- Helpers: resolve mapping for each group into _LED_TMP ----
[gcode_macro _LED_MAP_L]
gcode:
  {% set t = printer["gcode_macro LED_GROUPS"].L_type|string %}
  {% set led = printer["gcode_macro LED_GROUPS"].L_led|string %}
  {% set f = printer["gcode_macro LED_GROUPS"].L_from|int %}
  {% set o = printer["gcode_macro LED_GROUPS"].L_to|int %}
  SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=led  VALUE={"'" ~ led ~ "'"}
  {% if t == "strip" %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE=1
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE=99999
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE={f}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE={o}
  {% endif %}

[gcode_macro _LED_MAP_R]
gcode:
  {% set t = printer["gcode_macro LED_GROUPS"].R_type|string %}
  {% set led = printer["gcode_macro LED_GROUPS"].R_led|string %}
  {% set f = printer["gcode_macro LED_GROUPS"].R_from|int %}
  {% set o = printer["gcode_macro LED_GROUPS"].R_to|int %}
  SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=led  VALUE={"'" ~ led ~ "'"}
  {% if t == "strip" %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE=1
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE=99999
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE={f}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE={o}
  {% endif %}

[gcode_macro _LED_MAP_CL]
gcode:
  {% set t = printer["gcode_macro LED_GROUPS"].CL_type|string %}
  {% set led = printer["gcode_macro LED_GROUPS"].CL_led|string %}
  {% set f = printer["gcode_macro LED_GROUPS"].CL_from|int %}
  {% set o = printer["gcode_macro LED_GROUPS"].CL_to|int %}
  SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=led  VALUE={"'" ~ led ~ "'"}
  {% if t == "strip" %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE=1
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE=99999
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE={f}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE={o}
  {% endif %}

[gcode_macro _LED_MAP_CR]
gcode:
  {% set t = printer["gcode_macro LED_GROUPS"].CR_type|string %}
  {% set led = printer["gcode_macro LED_GROUPS"].CR_led|string %}
  {% set f = printer["gcode_macro LED_GROUPS"].CR_from|int %}
  {% set o = printer["gcode_macro LED_GROUPS"].CR_to|int %}
  SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=led  VALUE={"'" ~ led ~ "'"}
  {% if t == "strip" %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE=1
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE=99999
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE={f}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE={o}
  {% endif %}

[gcode_macro _LED_MAP_TH]
gcode:
  {% set t = printer["gcode_macro LED_GROUPS"].TH_type|string %}
  {% set led = printer["gcode_macro LED_GROUPS"].TH_led|string %}
  {% set f = printer["gcode_macro LED_GROUPS"].TH_from|int %}
  {% set o = printer["gcode_macro LED_GROUPS"].TH_to|int %}
  SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=led  VALUE={"'" ~ led ~ "'"}
  {% if t == "strip" %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE=1
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE=99999
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=from VALUE={f}
    SET_GCODE_VARIABLE MACRO=_LED_TMP VARIABLE=to   VALUE={o}
  {% endif %}

# ---- Render helper: solid color to a resolved range ----
[gcode_macro _LED_RANGE_SOLID]
gcode:
  {% set led = printer["gcode_macro _LED_TMP"].led|string %}
  {% set i0  = printer["gcode_macro _LED_TMP"].from|int %}
  {% set i1  = printer["gcode_macro _LED_TMP"].to|int %}
  {% set r   = params.R|default(0.0)|float %}
  {% set g   = params.G|default(0.0)|float %}
  {% set b   = params.B|default(0.0)|float %}
  {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
  {% for i in range(i0, i1+1) %}
    SET_LED LED={led} INDEX={i} RED={r} GREEN={g} BLUE={b} TRANSMIT={(1 if i==i1 else 0)}
  {% endfor %}

# ================== USER COMMANDS ==================
# Solid color per group (accepts 0..255 or 0..1)
[gcode_macro LED_L]
description: "LED_L [R=][G=][B=] (left)"
gcode:
  {% set br = printer["gcode_macro LED_STATE_L"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set div = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/div) * br %}{% set g = (g_in/div) * br %}{% set b = (b_in/div) * br %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=mode VALUE="'solid'"
  _LED_MAP_L
  _LED_RANGE_SOLID R={r} G={g} B={b}

[gcode_macro LED_R]
description: "LED_R [R=][G=][B=] (right)"
gcode:
  {% set br = printer["gcode_macro LED_STATE_R"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set div = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/div) * br %}{% set g = (g_in/div) * br %}{% set b = (b_in/div) * br %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'solid'"
  _LED_MAP_R
  _LED_RANGE_SOLID R={r} G={g} B={b}

[gcode_macro LED_CL]
description: "LED_CL [R=][G=][B=] (chain-left)"
gcode:
  {% set br = printer["gcode_macro LED_STATE_CL"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set div = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/div) * br %}{% set g = (g_in/div) * br %}{% set b = (b_in/div) * br %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=mode VALUE="'solid'"
  _LED_MAP_CL
  _LED_RANGE_SOLID R={r} G={g} B={b}

[gcode_macro LED_CR]
description: "LED_CR [R=][G=][B=] (chain-right)"
gcode:
  {% set br = printer["gcode_macro LED_STATE_CR"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set div = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/div) * br %}{% set g = (g_in/div) * br %}{% set b = (b_in/div) * br %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=mode VALUE="'solid'"
  _LED_MAP_CR
  _LED_RANGE_SOLID R={r} G={g} B={b}

[gcode_macro LED_TH]
description: "LED_TH [R=][G=][B=] (toolhead)"
gcode:
  {% set br = printer["gcode_macro LED_STATE_TH"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set div = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/div) * br %}{% set g = (g_in/div) * br %}{% set b = (b_in/div) * br %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=mode VALUE="'solid'"
  _LED_MAP_TH
  _LED_RANGE_SOLID R={r} G={g} B={b}

# ---- OFF commands
[gcode_macro LED_OFF_L]  gcode: SET_GCODE_VARIABLE MACRO=LED_STATE_L  VARIABLE=mode VALUE="'off'"\n _LED_MAP_L  \n _LED_RANGE_SOLID R=0 G=0 B=0
[gcode_macro LED_OFF_R]  gcode: SET_GCODE_VARIABLE MACRO=LED_STATE_R  VARIABLE=mode VALUE="'off'"\n _LED_MAP_R  \n _LED_RANGE_SOLID R=0 G=0 B=0
[gcode_macro LED_OFF_CL] gcode: SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=mode VALUE="'off'"\n _LED_MAP_CL \n _LED_RANGE_SOLID R=0 G=0 B=0
[gcode_macro LED_OFF_CR] gcode: SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=mode VALUE="'off'"\n _LED_MAP_CR \n _LED_RANGE_SOLID R=0 G=0 B=0
[gcode_macro LED_OFF_TH] gcode: SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=mode VALUE="'off'"\n _LED_MAP_TH \n _LED_RANGE_SOLID R=0 G=0 B=0

# ---- Brightness per group (re-applies solid color if needed)
[gcode_macro LED_BRIGHT_L]
description: "LED_BRIGHT_L B=0..1"
gcode:
  {% set b = params.B|default(printer["gcode_macro LED_STATE_L"].brightness)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}{% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=brightness VALUE={b}
  {action_respond_info("Left brightness " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE_L"].mode == "solid" %}
    LED_L R={(printer["gcode_macro LED_STATE_L"].r / (printer["gcode_macro LED_STATE_L"].brightness if printer["gcode_macro LED_STATE_L"].brightness>0 else 1.0))*255}
         G={(printer["gcode_macro LED_STATE_L"].g / (printer["gcode_macro LED_STATE_L"].brightness if printer["gcode_macro LED_STATE_L"].brightness>0 else 1.0))*255}
         B={(printer["gcode_macro LED_STATE_L"].b / (printer["gcode_macro LED_STATE_L"].brightness if printer["gcode_macro LED_STATE_L"].brightness>0 else 1.0))*255}
  {% endif %}

[gcode_macro LED_BRIGHT_R]
description: "LED_BRIGHT_R B=0..1"
gcode:
  {% set b = params.B|default(printer["gcode_macro LED_STATE_R"].brightness)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}{% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=brightness VALUE={b}
  {action_respond_info("Right brightness " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE_R"].mode == "solid" %}
    LED_R R={(printer["gcode_macro LED_STATE_R"].r / (printer["gcode_macro LED_STATE_R"].brightness if printer["gcode_macro LED_STATE_R"].brightness>0 else 1.0))*255}
         G={(printer["gcode_macro LED_STATE_R"].g / (printer["gcode_macro LED_STATE_R"].brightness if printer["gcode_macro LED_STATE_R"].brightness>0 else 1.0))*255}
         B={(printer["gcode_macro LED_STATE_R"].b / (printer["gcode_macro LED_STATE_R"].brightness if printer["gcode_macro LED_STATE_R"].brightness>0 else 1.0))*255}
  {% endif %}

[gcode_macro LED_BRIGHT_CL]
description: "LED_BRIGHT_CL B=0..1"
gcode:
  {% set b = params.B|default(printer["gcode_macro LED_STATE_CL"].brightness)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}{% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=brightness VALUE={b}
  {action_respond_info("Chain-L brightness " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE_CL"].mode == "solid" %}
    LED_CL R={(printer["gcode_macro LED_STATE_CL"].r / (printer["gcode_macro LED_STATE_CL"].brightness if printer["gcode_macro LED_STATE_CL"].brightness>0 else 1.0))*255}
          G={(printer["gcode_macro LED_STATE_CL"].g / (printer["gcode_macro LED_STATE_CL"].brightness if printer["gcode_macro LED_STATE_CL"].brightness>0 else 1.0))*255}
          B={(printer["gcode_macro LED_STATE_CL"].b / (printer["gcode_macro LED_STATE_CL"].brightness if printer["gcode_macro LED_STATE_CL"].brightness>0 else 1.0))*255}
  {% endif %}

[gcode_macro LED_BRIGHT_CR]
description: "LED_BRIGHT_CR B=0..1"
gcode:
  {% set b = params.B|default(printer["gcode_macro LED_STATE_CR"].brightness)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}{% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=brightness VALUE={b}
  {action_respond_info("Chain-R brightness " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE_CR"].mode == "solid" %}
    LED_CR R={(printer["gcode_macro LED_STATE_CR"].r / (printer["gcode_macro LED_STATE_CR"].brightness if printer["gcode_macro LED_STATE_CR"].brightness>0 else 1.0))*255}
          G={(printer["gcode_macro LED_STATE_CR"].g / (printer["gcode_macro LED_STATE_CR"].brightness if printer["gcode_macro LED_STATE_CR"].brightness>0 else 1.0))*255}
          B={(printer["gcode_macro LED_STATE_CR"].b / (printer["gcode_macro LED_STATE_CR"].brightness if printer["gcode_macro LED_STATE_CR"].brightness>0 else 1.0))*255}
  {% endif %}

[gcode_macro LED_BRIGHT_TH]
description: "LED_BRIGHT_TH B=0..1"
gcode:
  {% set b = params.B|default(printer["gcode_macro LED_STATE_TH"].brightness)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}{% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=brightness VALUE={b}
  {action_respond_info("Toolhead brightness " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE_TH"].mode == "solid" %}
    LED_TH R={(printer["gcode_macro LED_STATE_TH"].r / (printer["gcode_macro LED_STATE_TH"].brightness if printer["gcode_macro LED_STATE_TH"].brightness>0 else 1.0))*255}
          G={(printer["gcode_macro LED_STATE_TH"].g / (printer["gcode_macro LED_STATE_TH"].brightness if printer["gcode_macro LED_STATE_TH"].brightness>0 else 1.0))*255}
          B={(printer["gcode_macro LED_STATE_TH"].b / (printer["gcode_macro LED_STATE_TH"].brightness if printer["gcode_macro LED_STATE_TH"].brightness>0 else 1.0))*255}
  {% endif %}

# ---- Effects per group: off|pulse|chase|progress ----
[gcode_macro LED_EFFECT_L]
description: "LED_EFFECT_L MODE=off|pulse|chase|progress"
gcode:
  {% set m = params.MODE|default("off")|lower %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=mode VALUE={"'" ~ m ~ "'"}
  UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION=0.05

[gcode_macro LED_EFFECT_R]
description: "LED_EFFECT_R MODE=off|pulse|chase|progress"
gcode:
  {% set m = params.MODE|default("off")|lower %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE={"'" ~ m ~ "'"}
  UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION=0.05

[gcode_macro LED_EFFECT_CL]
description: "LED_EFFECT_CL MODE=off|pulse|chase|progress"
gcode:
  {% set m = params.MODE|default("off")|lower %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=mode VALUE={"'" ~ m ~ "'"}
  UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION=0.05

[gcode_macro LED_EFFECT_CR]
description: "LED_EFFECT_CR MODE=off|pulse|chase|progress"
gcode:
  {% set m = params.MODE|default("off")|lower %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=mode VALUE={"'" ~ m ~ "'"}
  UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION=0.05

[gcode_macro LED_EFFECT_TH]
description: "LED_EFFECT_TH MODE=off|pulse|chase|progress"
gcode:
  {% set m = params.MODE|default("off")|lower %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=mode VALUE={"'" ~ m ~ "'"}
  UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION=0.05

# ---- All-groups ticker (updates any group in effect mode) ----
[delayed_gcode LED_TICK_ALL]
gcode:
  {% set tf = printer["gcode_macro LED_GROUPS"].tick_fast|float %}
  {% set ts = printer["gcode_macro LED_GROUPS"].tick_slow|float %}

  # --- helper to render one group (inline repeated five times with group-specific mapping) ---

  # L
  {% set mode = printer["gcode_macro LED_STATE_L"].mode|string %}
  {% set r0 = printer["gcode_macro LED_STATE_L"].r|float %}
  {% set g0 = printer["gcode_macro LED_STATE_L"].g|float %}
  {% set b0 = printer["gcode_macro LED_STATE_L"].b|float %}
  _LED_MAP_L
  {% set led = printer["gcode_macro _LED_TMP"].led|string %}
  {% set i0 = printer["gcode_macro _LED_TMP"].from|int %}
  {% set i1 = printer["gcode_macro _LED_TMP"].to|int %}
  {% set span = (i1 - i0 + 1)|int %}
  {% if span < 1 %}{% set span = 1 %}{% endif %}
  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_L"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_L"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0*v2 %}{% set gg = g0*v2 %}{% set bb = b0*v2 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==i1 else 0)}
    {% endfor %}
    {% set tickL = tf %}
  {% elif mode == "chase" %}
    {% set t = (printer["gcode_macro LED_STATE_L"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=tick VALUE={t}
    {% set idx = i0 + (t % span) %}
    {% set dim = 0.05 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickL = tf %}
  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}{% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (span * prog)|int %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for j in range(0, span) %}
      {% set i = i0 + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickL = ts %}
  {% else %}
    {% set tickL = 0 %}
  {% endif %}

  # R
  {% set mode = printer["gcode_macro LED_STATE_R"].mode|string %}
  {% set r0 = printer["gcode_macro LED_STATE_R"].r|float %}
  {% set g0 = printer["gcode_macro LED_STATE_R"].g|float %}
  {% set b0 = printer["gcode_macro LED_STATE_R"].b|float %}
  _LED_MAP_R
  {% set led = printer["gcode_macro _LED_TMP"].led|string %}
  {% set i0 = printer["gcode_macro _LED_TMP"].from|int %}
  {% set i1 = printer["gcode_macro _LED_TMP"].to|int %}
  {% set span = (i1 - i0 + 1)|int %}{% if span < 1 %}{% set span = 1 %}{% endif %}
  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_R"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_R"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0*v2 %}{% set gg = g0*v2 %}{% set bb = b0*v2 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==i1 else 0)}
    {% endfor %}
    {% set tickR = tf %}
  {% elif mode == "chase" %}
    {% set t = (printer["gcode_macro LED_STATE_R"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=tick VALUE={t}
    {% set idx = i0 + (t % span) %}
    {% set dim = 0.05 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickR = tf %}
  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}{% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (span * prog)|int %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for j in range(0, span) %}
      {% set i = i0 + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickR = ts %}
  {% else %}
    {% set tickR = 0 %}
  {% endif %}

  # CL
  {% set mode = printer["gcode_macro LED_STATE_CL"].mode|string %}
  {% set r0 = printer["gcode_macro LED_STATE_CL"].r|float %}
  {% set g0 = printer["gcode_macro LED_STATE_CL"].g|float %}
  {% set b0 = printer["gcode_macro LED_STATE_CL"].b|float %}
  _LED_MAP_CL
  {% set led = printer["gcode_macro _LED_TMP"].led|string %}
  {% set i0 = printer["gcode_macro _LED_TMP"].from|int %}
  {% set i1 = printer["gcode_macro _LED_TMP"].to|int %}
  {% set span = (i1 - i0 + 1)|int %}{% if span < 1 %}{% set span = 1 %}{% endif %}
  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_CL"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_CL"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0*v2 %}{% set gg = g0*v2 %}{% set bb = b0*v2 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==i1 else 0)}
    {% endfor %}
    {% set tickCL = tf %}
  {% elif mode == "chase" %}
    {% set t = (printer["gcode_macro LED_STATE_CL"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_CL VARIABLE=tick VALUE={t}
    {% set idx = i0 + (t % span) %}
    {% set dim = 0.05 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickCL = tf %}
  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}{% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (span * prog)|int %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for j in range(0, span) %}
      {% set i = i0 + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickCL = ts %}
  {% else %}
    {% set tickCL = 0 %}
  {% endif %}

  # CR
  {% set mode = printer["gcode_macro LED_STATE_CR"].mode|string %}
  {% set r0 = printer["gcode_macro LED_STATE_CR"].r|float %}
  {% set g0 = printer["gcode_macro LED_STATE_CR"].g|float %}
  {% set b0 = printer["gcode_macro LED_STATE_CR"].b|float %}
  _LED_MAP_CR
  {% set led = printer["gcode_macro _LED_TMP"].led|string %}
  {% set i0 = printer["gcode_macro _LED_TMP"].from|int %}
  {% set i1 = printer["gcode_macro _LED_TMP"].to|int %}
  {% set span = (i1 - i0 + 1)|int %}{% if span < 1 %}{% set span = 1 %}{% endif %}
  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_CR"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_CR"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0*v2 %}{% set gg = g0*v2 %}{% set bb = b0*v2 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==i1 else 0)}
    {% endfor %}
    {% set tickCR = tf %}
  {% elif mode == "chase" %}
    {% set t = (printer["gcode_macro LED_STATE_CR"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_CR VARIABLE=tick VALUE={t}
    {% set idx = i0 + (t % span) %}
    {% set dim = 0.05 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickCR = tf %}
  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}{% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (span * prog)|int %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for j in range(0, span) %}
      {% set i = i0 + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickCR = ts %}
  {% else %}
    {% set tickCR = 0 %}
  {% endif %}

  # TH
  {% set mode = printer["gcode_macro LED_STATE_TH"].mode|string %}
  {% set r0 = printer["gcode_macro LED_STATE_TH"].r|float %}
  {% set g0 = printer["gcode_macro LED_STATE_TH"].g|float %}
  {% set b0 = printer["gcode_macro LED_STATE_TH"].b|float %}
  _LED_MAP_TH
  {% set led = printer["gcode_macro _LED_TMP"].led|string %}
  {% set i0 = printer["gcode_macro _LED_TMP"].from|int %}
  {% set i1 = printer["gcode_macro _LED_TMP"].to|int %}
  {% set span = (i1 - i0 + 1)|int %}{% if span < 1 %}{% set span = 1 %}{% endif %}
  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_TH"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_TH"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0*v2 %}{% set gg = g0*v2 %}{% set bb = b0*v2 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==i1 else 0)}
    {% endfor %}
    {% set tickTH = tf %}
  {% elif mode == "chase" %}
    {% set t = (printer["gcode_macro LED_STATE_TH"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_TH VARIABLE=tick VALUE={t}
    {% set idx = i0 + (t % span) %}
    {% set dim = 0.05 %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for i in range(i0, i1+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickTH = tf %}
  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}{% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (span * prog)|int %}
    {% if i1 > 90000 %}{% set i1 = i0 %}{% endif %}
    {% for j in range(0, span) %}
      {% set i = i0 + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==i1 else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==i1 else 0)}
      {% endif %}
    {% endfor %}
    {% set tickTH = ts %}
  {% else %}
    {% set tickTH = 0 %}
  {% endif %}

  # Decide next tick: if any group is in an effect, keep ticking; else stop
  {% set next = 0 %}
  {% if printer["gcode_macro LED_STATE_L"].mode|string in ["pulse","chase","progress"] %}{% set next = tf %}{% endif %}
  {% if printer["gcode_macro LED_STATE_R"].mode|string in ["pulse","chase","progress"] %}{% set next = tf %}{% endif %}
  {% if printer["gcode_macro LED_STATE_CL"].mode|string in ["pulse","chase","progress"] %}{% set next = tf %}{% endif %}
  {% if printer["gcode_macro LED_STATE_CR"].mode|string in ["pulse","chase","progress"] %}{% set next = tf %}{% endif %}
  {% if printer["gcode_macro LED_STATE_TH"].mode|string in ["pulse","chase","progress"] %}{% set next = tf %}{% endif %}
  {% if next > 0 %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION={next}
  {% else %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_ALL DURATION=0
  {% endif %}
