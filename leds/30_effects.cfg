[delayed_gcode LED_TICK]
gcode:
  {% set led    = printer["gcode_macro LED_STATE"].led|string %}
  {% set count  = printer["gcode_macro LED_STATE"].count|int %}
  {% set mode   = printer["gcode_macro LED_STATE"].mode|string %}
  {% set r_base = printer["gcode_macro LED_STATE"].r|float %}
  {% set g_base = printer["gcode_macro LED_STATE"].g|float %}
  {% set b_base = printer["gcode_macro LED_STATE"].b|float %}

  {% if mode == "pulse" %}
    {% set val  = printer["gcode_macro LED_STATE"].pulse_val|float %}
    {% set dir  = printer["gcode_macro LED_STATE"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r_base * v2 %}{% set gg = g_base * v2 %}{% set bb = b_base * v2 %}
    SET_LED LED={led} RED={rr} GREEN={gg} BLUE={bb}
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.05

  {% elif mode == "chase" %}
    {% set tick = (printer["gcode_macro LED_STATE"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=tick VALUE={tick}
    {% set idx = tick % count %}
    {% if idx < 0 %}{% set idx = 0 %}{% endif %}
    {% set dim = 0.05 %}
    {% for i in range(count) %}
      {% set rr = r_base*dim %}{% set gg = g_base*dim %}{% set bb = b_base*dim %}
      SET_LED LED={led} INDEX={i+1} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT=0
    {% endfor %}
    SET_LED LED={led} INDEX={idx+1} RED={r_base} GREEN={g_base} BLUE={b_base} TRANSMIT=1
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.05

  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}
    {% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (count * prog)|int %}
    {% for i in range(count) %}
      {% if i < lit %}
        SET_LED LED={led} INDEX={i+1} RED={r_base} GREEN={g_base} BLUE={b_base} TRANSMIT=0
      {% else %}
        SET_LED LED={led} INDEX={i+1} RED=0 GREEN=0 BLUE=0 TRANSMIT=0
      {% endif %}
    {% endfor %}
    SET_LED LED={led} INDEX={count} RED=0 GREEN=0 BLUE=0 TRANSMIT=1
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.25

  {% else %}
    UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0
  {% endif %}
