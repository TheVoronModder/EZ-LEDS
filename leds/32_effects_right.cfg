[delayed_gcode LED_TICK_R]
gcode:
  {% set led  = printer["gcode_macro LED_ZONES"].led|string %}
  {% set rf   = printer["gcode_macro LED_ZONES"].right_from|int %}
  {% set rt   = printer["gcode_macro LED_ZONES"].right_to|int %}
  {% set mode = printer["gcode_macro LED_STATE_R"].mode|string %}
  {% set br   = printer["gcode_macro LED_STATE_R"].brightness|float %}
  {% set r0   = printer["gcode_macro LED_STATE_R"].r|float %}
  {% set g0   = printer["gcode_macro LED_STATE_R"].g|float %}
  {% set b0   = printer["gcode_macro LED_STATE_R"].b|float %}
  {% set span = (rt - rf + 1)|int %}

  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_R"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_R"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0 * v2 %}{% set gg = g0 * v2 %}{% set bb = b0 * v2 %}
    {% for i in range(rf, rt+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==rt else 0)}
    {% endfor %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0.05

  {% elif mode == "chase" %}
    {% set tick = (printer["gcode_macro LED_STATE_R"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=tick VALUE={tick}
    {% set idx = rf + (tick % span) %}
    {% set dim = 0.05 %}
    {% for i in range(rf, rt+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==rt else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==rt else 0)}
      {% endif %}
    {% endfor %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0.05

  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}
    {% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set span2 = (rt - rf + 1)|int %}
    {% set lit = (span2 * prog)|int %}
    {% for j in range(0, span2) %}
      {% set i = rf + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==rt else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==rt else 0)}
      {% endif %}
    {% endfor %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0.25

  {% else %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0
  {% endif %}
