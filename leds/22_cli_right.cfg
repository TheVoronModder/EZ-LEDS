[gcode_macro LED_R]
description: "LED_R [R=][G=][B=]  (right zone)"
gcode:
  {% set led  = printer["gcode_macro LED_ZONES"].led|string %}
  {% set rf   = printer["gcode_macro LED_ZONES"].right_from|int %}
  {% set rt   = printer["gcode_macro LED_ZONES"].right_to|int %}
  {% set br   = printer["gcode_macro LED_STATE_R"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set div  = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/div) * br %}
  {% set g = (g_in/div) * br %}
  {% set b = (b_in/div) * br %}

  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'solid'"

  {% for i in range(rf, rt+1) %}
    SET_LED LED={led} INDEX={i} RED={r} GREEN={g} BLUE={b} TRANSMIT={(1 if i==rt else 0)}
  {% endfor %}

[gcode_macro LED_OFF_R]
gcode:
  {% set led  = printer["gcode_macro LED_ZONES"].led|string %}
  {% set rf   = printer["gcode_macro LED_ZONES"].right_from|int %}
  {% set rt   = printer["gcode_macro LED_ZONES"].right_to|int %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'off'"
  {% for i in range(rf, rt+1) %}
    SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==rt else 0)}
  {% endfor %}

[gcode_macro LED_BRIGHT_R]
description: "LED_BRIGHT_R B=0..1"
gcode:
  {% set b = params.B|default(0.30)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}
  {% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=brightness VALUE={b}
  {action_respond_info("Right brightness set to " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE_R"].mode == "solid" %}
    LED_R R={(printer["gcode_macro LED_STATE_R"].r/ (printer["gcode_macro LED_STATE_R"].brightness if printer["gcode_macro LED_STATE_R"].brightness>0 else 1.0))*255}
         G={(printer["gcode_macro LED_STATE_R"].g/ (printer["gcode_macro LED_STATE_R"].brightness if printer["gcode_macro LED_STATE_R"].brightness>0 else 1.0))*255}
         B={(printer["gcode_macro LED_STATE_R"].b/ (printer["gcode_macro LED_STATE_R"].brightness if printer["gcode_macro LED_STATE_R"].brightness>0 else 1.0))*255}
  {% endif %}

[gcode_macro LED_EFFECT_R]
description: "LED_EFFECT_R MODE=off|pulse|chase|progress"
gcode:
  {% set mode = params.MODE|default("off")|lower %}
  {% if mode == "off" %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'off'"
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0
  {% elif mode == "pulse" %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'pulse'"
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0.05
  {% elif mode == "chase" %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'chase'"
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0.05
  {% elif mode == "progress" %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_R VARIABLE=mode VALUE="'progress'"
    UPDATE_DELAYED_GCODE ID=LED_TICK_R DURATION=0.25
  {% else %}
    {action_respond_info("Unknown right mode: " ~ mode)}
  {% endif %}
