# LED: set a solid color (R,G,B as 0..255 or 0..1)
[gcode_macro LED]
description: "LED [R=][G=][B=] [LED=rear_strip] (0..255 or 0..1)"
gcode:
  {% set led = params.LED|default(printer["gcode_macro LED_STATE"].led)|string %}
  {% set br  = printer["gcode_macro LED_STATE"].brightness|float %}
  {% set r_in = params.R|default(255)|float %}
  {% set g_in = params.G|default(255)|float %}
  {% set b_in = params.B|default(255)|float %}
  {% set scale_div = 255.0 if (r_in>1.0 or g_in>1.0 or b_in>1.0) else 1.0 %}
  {% set r = (r_in/scale_div) * br %}
  {% set g = (g_in/scale_div) * br %}
  {% set b = (b_in/scale_div) * br %}
  {% set led_q = "'" ~ led ~ "'" %}

  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=led VALUE={led_q}
  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=r VALUE={r}
  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=g VALUE={g}
  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=b VALUE={b}
  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=mode VALUE="'solid'"

  SET_LED LED={led} RED={r} GREEN={g} BLUE={b}

[gcode_macro LED_OFF]
gcode:
  {% set led = printer["gcode_macro LED_STATE"].led|string %}
  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=mode VALUE="'off'"
  SET_LED LED={led} RED=0 GREEN=0 BLUE=0

[gcode_macro LED_BRIGHT]
description: "LED_BRIGHT B=0..1"
gcode:
  {% set b = params.B|default(0.3)|float %}
  {% if b < 0.0 %}{% set b = 0.0 %}{% endif %}
  {% if b > 1.0 %}{% set b = 1.0 %}{% endif %}
  SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=brightness VALUE={b}
  {action_respond_info("LED brightness set to " ~ ("%0.2f"|format(b)))}
  {% if printer["gcode_macro LED_STATE"].mode == "solid" %}
    {% set led = printer["gcode_macro LED_STATE"].led|string %}
    {% set r_base = printer["gcode_macro LED_STATE"].r|float %}
    {% set g_base = printer["gcode_macro LED_STATE"].g|float %}
    {% set b_base = printer["gcode_macro LED_STATE"].b|float %}
    SET_LED LED={led} RED={r_base} GREEN={g_base} BLUE={b_base}
  {% endif %}

[gcode_macro LED_SCENE]
description: "LED_SCENE NAME=idle|heating|printing|paused|error"
gcode:
  {% set name = params.NAME|default("idle")|lower %}
  {% if name == "idle" %}
    LED R=0 G=0 B=64
  {% elif name == "heating" %}
    LED R=255 G=32 B=0
  {% elif name == "printing" %}
    LED R=0 G=64 B=255
  {% elif name == "paused" %}
    LED R=255 G=255 B=0
  {% elif name == "error" %}
    LED R=255 G=0 B=0
  {% else %}
    {action_respond_info("Unknown scene: " ~ name)}
  {% endif %}

[gcode_macro LED_EFFECT]
description: "LED_EFFECT MODE=off|pulse|chase|progress"
gcode:
  {% set mode = params.MODE|default("off")|lower %}
  {% if mode not in ["off","pulse","chase","progress"] %}
    {action_respond_info("Unknown mode: " ~ mode)}
  {% else %}
    {% set mode_q = "'" ~ mode ~ "'" %}
    SET_GCODE_VARIABLE MACRO=LED_STATE VARIABLE=mode VALUE={mode_q}
    {% if mode != "off" %}
      UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0.05
    {% else %}
      UPDATE_DELAYED_GCODE ID=LED_TICK DURATION=0
    {% endif %}
  {% endif %}
