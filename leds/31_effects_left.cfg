[delayed_gcode LED_TICK_L]
gcode:
  {% set led  = printer["gcode_macro LED_ZONES"].led|string %}
  {% set lf   = printer["gcode_macro LED_ZONES"].left_from|int %}
  {% set lt   = printer["gcode_macro LED_ZONES"].left_to|int %}
  {% set mode = printer["gcode_macro LED_STATE_L"].mode|string %}
  {% set br   = printer["gcode_macro LED_STATE_L"].brightness|float %}
  {% set r0   = printer["gcode_macro LED_STATE_L"].r|float %}
  {% set g0   = printer["gcode_macro LED_STATE_L"].g|float %}
  {% set b0   = printer["gcode_macro LED_STATE_L"].b|float %}
  {% set span = (lt - lf + 1)|int %}

  {% if mode == "pulse" %}
    {% set val = printer["gcode_macro LED_STATE_L"].pulse_val|float %}
    {% set dir = printer["gcode_macro LED_STATE_L"].pulse_dir|float %}
    {% set step = 0.05 %}
    {% set v2 = val + step*dir %}
    {% if v2 >= 1.0 %}{% set v2 = 1.0 %}{% set dir = -1.0 %}{% endif %}
    {% if v2 <= 0.10 %}{% set v2 = 0.10 %}{% set dir = 1.0 %}{% endif %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=pulse_val VALUE={v2}
    SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=pulse_dir VALUE={dir}
    {% set rr = r0 * v2 %}{% set gg = g0 * v2 %}{% set bb = b0 * v2 %}
    {% for i in range(lf, lt+1) %}
      SET_LED LED={led} INDEX={i} RED={rr} GREEN={gg} BLUE={bb} TRANSMIT={(1 if i==lt else 0)}
    {% endfor %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_L DURATION=0.05

  {% elif mode == "chase" %}
    {% set tick = (printer["gcode_macro LED_STATE_L"].tick|int) + 1 %}
    SET_GCODE_VARIABLE MACRO=LED_STATE_L VARIABLE=tick VALUE={tick}
    {% set idx = lf + (tick % span) %}
    {% set dim = 0.05 %}
    {% for i in range(lf, lt+1) %}
      {% if i == idx %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==lt else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED={(r0*dim)} GREEN={(g0*dim)} BLUE={(b0*dim)} TRANSMIT={(1 if i==lt else 0)}
      {% endif %}
    {% endfor %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_L DURATION=0.05

  {% elif mode == "progress" %}
    {% set prog = printer.print_stats.progress|float %}
    {% if prog < 0.0 %}{% set prog = 0.0 %}{% endif %}
    {% if prog > 1.0 %}{% set prog = 1.0 %}{% endif %}
    {% set lit = (span * prog)|int %}
    {% for j in range(0, span) %}
      {% set i = lf + j %}
      {% if j < lit %}
        SET_LED LED={led} INDEX={i} RED={r0} GREEN={g0} BLUE={b0} TRANSMIT={(1 if i==lt else 0)}
      {% else %}
        SET_LED LED={led} INDEX={i} RED=0 GREEN=0 BLUE=0 TRANSMIT={(1 if i==lt else 0)}
      {% endif %}
    {% endfor %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_L DURATION=0.25

  {% else %}
    UPDATE_DELAYED_GCODE ID=LED_TICK_L DURATION=0
  {% endif %}
